<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mini File Server</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 2rem; }
    table { border-collapse: collapse; width: 100%; }
    th, td { padding: 0.4rem 0.6rem; border: 1px solid #ccc; }
    .actions button { margin-right: 0.3rem; }
    #msg { margin: 1rem 0; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Mini File Server</h1>

  <h2>Upload</h2>
  <form id="upForm">
    <input type="file" name="file" required />
    <button type="submit">Upload</button>
  </form>
  <div id="msg"></div>

  <h2>Files</h2>
  <table id="fileTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Size</th>
        <th>SHA-256</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const api = ""; // same origin
    const tbody = document.querySelector("#fileTable tbody");
    const msg = document.getElementById("msg");

    function showMessage(text, ok = true) {
      msg.textContent = text;
      msg.style.color = ok ? "green" : "red";
      setTimeout(() => (msg.textContent = ""), 4000);
    }

    // Load file list
    async function loadList() {
      try {
        const res = await fetch(api + "/list");
        if (!res.ok) throw new Error("list failed");
        const files = await res.json();
        tbody.innerHTML = "";
        files.forEach((f) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${f.name}</td>
            <td>${f.size}</td>
            <td><code>${f.sha256?.slice(0, 16)}â€¦</code></td>
            <td class="actions">
              <button onclick="downloadFile('${f.name}')">â¬‡ Download</button>
              <button onclick="deleteFile('${f.name}')">ðŸ—‘ Delete</button>
            </td>`;
          tbody.appendChild(tr);
        });
      } catch (e) {
        showMessage("Cannot load files: " + e.message, false);
      }
    }

    // Download (browser will prompt save)
    function downloadFile(name) {
      window.open(api + "/files/" + encodeURIComponent(name), "_blank");
    }

    // Delete with Basic-Auth prompt
    async function deleteFile(name) {
      const user = prompt("User name:");
      if (!user) return;
      const pass = prompt("Password:");
      if (!pass) return;

      try {
        const res = await fetch(api + "/delete?name=" + encodeURIComponent(name), {
          method: "DELETE",
          headers: {
            Authorization: "Basic " + btoa(user + ":" + pass),
          },
        });
        if (res.status === 401) throw new Error("wrong credentials");
        if (!res.ok) throw new Error("delete failed");
        showMessage("Deleted " + name);
        loadList();
      } catch (e) {
        showMessage(e.message, false);
      }
    }

    // Upload with Basic-Auth prompt
    document.getElementById("upForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const file = e.target.file.files[0];
      if (!file) return;

    //   const user = prompt("User name:");
    //   if (!user) return;
    //   const pass = prompt("Password:");
    //   if (!pass) return;

      const body = new FormData();
      body.append("file", file);

      try {
        const res = await fetch(api + "/upload", {
          method: "POST",
        //   headers: {
        //     Authorization: "Basic " + btoa(user + ":" + pass),
        //   },
          body,
        });
        if (res.status === 401) throw new Error("wrong credentials");
        if (!res.ok) throw new Error("upload failed");
        showMessage("Uploaded " + file.name);
        e.target.reset();
        loadList();
      } catch (err) {
        showMessage(err.message, false);
      }
    });

    // initial load
    loadList();
  </script>
</body>
</html>